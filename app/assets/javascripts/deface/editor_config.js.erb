var Deface = {
  Views: {Shared: {}, Themes: {}, ViewOverrides: {}, Stylesheets: {}, Javascripts: {}, Graphics: {} },
  Routers: {},
  Collections: {},

  templates: [],

  view: null,

  current: 'html',

  previous: { html: null, css: null, js: null, files: null },

  theme_id: <%= Theme.active.first.id %>,

  theme_name: '<%= Theme.active.first.name %>',

  editor: {minimised: true, maximised: false, visible: false },

  activity: 0,

  init: function() {
    view_overrides_controller = new Deface.Routers.ViewOverrides();
    view_overrides_controller.load();

    new Deface.Routers.Common();
    new Deface.Routers.Themes();
    new Deface.Routers.Templates();
    new Deface.Routers.Stylesheets();
    new Deface.Routers.Javascripts();
    new Deface.Routers.Graphics();

    Backbone.history.start();

    Deface.increment_activity() //for iframe load

    //render toolbar
    new Deface.Views.Shared.Toolbar();
  },

  increment_activity: function(){
    Deface.activity += 1;
    $('img#busy').css("visibility", "visible");
  },

  decrement_activity: function(){
    Deface.activity -= 1;

    if(Deface.activity<=0){
      $('img#busy').css("visibility", "hidden");
      Deface.activity = 0;
    }
  },

  animate_resize: function(){
    var pre_height = $("div#deface_editor").height();

    var height = 50;
    if(Deface.view!=null){
      height += Deface.view.calculate_size();
    }

    if(Deface.editor.visible){
      if(Deface.editor.minimised){
        $('#nav li#min').addClass('disabled');
        $('#nav li#restore').removeClass('disabled');
        $('#nav li#max').removeClass('disabled');
      }else if(Deface.editor.maximised){
        $('#nav li#min').removeClass('disabled');
        $('#nav li#restore').removeClass('disabled');
        $('#nav li#max').addClass('disabled');
      }else{ //restore
        $('#nav li#min').removeClass('disabled');
        $('#nav li#restore').addClass('disabled');
        $('#nav li#max').removeClass('disabled');
      }
    }else{
      $('#nav li#min').addClass('disabled');
      $('#nav li#restore').addClass('disabled');
      $('#nav li#max').addClass('disabled');
    }

    var t = Math.abs((pre_height - height) * 5);
    if(t<400){
      t = 400;
    }else if(t>1500){
      t = 1500;
    }

    $("div#deface_editor").animate({height: height + 'px'}, t);
  },

  set_current: function(value){
    Deface.previous[Deface.current] = Deface.view;
    Deface.view = null;
    Deface.current = value;

    $("div#nav ul#current li").removeClass("active");
    $("div#nav ul#current li#" + value).addClass("active");

    if(Deface.previous[value]!=undefined){
      Deface.view = Deface.previous[value];
      Deface.view.render();
      Deface.view.delegateEvents();

      return true;
    }else{
      $("#loadables").css("visibility", "hidden");
      $('#main').html('');

      return false;
    }
  },

  reset_editor: function(){
    Deface.editor = {minimised: true, maximised: false, visible: false };
    Deface.animate_resize();

    Deface.previous[Deface.current] = null;
    Deface.view = null;
  },

  reload_frame: function(){
    window.frames[0].location.reload();
  },

  handle_save_error: function(model, errors){
    Deface.decrement_activity();

    _.each(errors, function(message, field){
      $("[name='" + field + "']").addClass('error');
      $("[name='" + field + "']").after("<span title='" + message + "' class='error_icon'>E<span>")
    });
  },

  clear_errors: function(){
    $(".error").removeClass("error");
    $(".error_icon").remove();
  }
};


